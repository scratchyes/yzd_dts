#==========================================================================
# Description: Build and Test Armbian with Apt-Retry Fix for RK3399-YZD
# Copyright (C) 2026 https://github.com/scratchyes/yzd_dts
# This workflow tests the apt-retry improvements by building actual firmware
#==========================================================================

name: Build Armbian with Apt-Retry Fix

on:
  push:
    branches:
      - copilot/fix-ci-task-apt-update-error
  pull_request:
    branches:
      - main
      - master

env:
  TZ: Asia/Shanghai
  ARMBIAN_MIRROR: "https://mirrors.tuna.tsinghua.edu.cn/armbian"

jobs:
  build:
    runs-on: ubuntu-22.04
    name: Build RK3399-YZD Armbian with Apt-Retry Fix
    permissions:
      contents: write  # Required for creating releases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi $(docker images -q) 2>/dev/null || true
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          
          # Robust apt-get update with retry logic and cache clearing
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
              echo "尝试第 ${attempt}/${max_attempts} 次 apt-get update..."
              sudo apt-get clean
              sudo rm -rf /var/lib/apt/lists/*
              if sudo -E apt-get -y update; then
                  echo "apt-get update 成功!"
                  break
              fi
              if [ $attempt -eq $max_attempts ]; then
                  echo "错误: apt-get update 在 ${max_attempts} 次尝试后仍然失败"
                  exit 1
              fi
              echo "apt-get update 失败，等待 10 秒后重试..."
              sleep 10
              attempt=$((attempt+1))
          done
          
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install device-tree-compiler qemu-user-static binfmt-support
          sudo -E systemctl daemon-reload
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo timedatectl set-timezone "${TZ}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Compile DTB from modified DTS
        id: compile_dtb
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "编译修改后的DTS为DTB..."
          dtc -I dts -O dtb -o rk3399-yzd-linux.dtb rk3399-yzd.dts 2>&1 | grep -v "Warning" || true
          if [ -f rk3399-yzd-linux.dtb ]; then
            echo "DTB编译成功: rk3399-yzd-linux.dtb"
            ls -lh rk3399-yzd-linux.dtb
            echo "status=success" >> ${GITHUB_OUTPUT}
          else
            echo "DTB编译失败"
            exit 1
          fi

      - name: Create build directory structure
        id: prepare
        if: ${{ steps.compile_dtb.outputs.status }} == 'success' && !cancelled()
        run: |
          sudo mkdir -p /builder
          sudo chown $USER:$USER /builder
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Download Armbian repository
        id: down
        working-directory: /builder
        if: ${{ steps.prepare.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "克隆Armbian仓库..."
          git clone --depth 1 --single-branch --branch main https://github.com/armbian/build build
          
          echo "克隆linux-rockchip内核源..."
          mkdir -p build/cache/sources
          git clone --depth 1 https://github.com/armbian/linux-rockchip build/cache/sources/linux-rockchip
          
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Prepare RK3399-YZD DTS and DTB
        working-directory: /builder
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "准备RK3399-YZD设备树文件..."
          
          # 复制DTB到工作目录
          cp ${GITHUB_WORKSPACE}/rk3399-yzd-linux.dtb /builder/
          
          # 创建userpatches目录结构
          mkdir -p build/userpatches/overlay
          mkdir -p build/userpatches/extensions
          
          # 复制DTS源文件
          cp ${GITHUB_WORKSPACE}/rk3399-yzd.dts build/userpatches/overlay/
          
          # 复制镜像配置文件到userpatches目录
          echo "复制Armbian镜像配置..."
          cp ${GITHUB_WORKSPACE}/userpatches/config-default.conf build/userpatches/
          cat build/userpatches/config-default.conf
          
          echo "设备树文件准备完成"

      - name: Download AP6356S firmware
        working-directory: /builder
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "下载AP6356S无线固件..."
          mkdir -p build/userpatches/overlay/lib/firmware/brcm
          
          # 下载AP6356S固件文件
          wget -O build/userpatches/overlay/lib/firmware/brcm/brcmfmac4356-sdio.txt \
            https://github.com/armbian/firmware/raw/master/brcm/brcmfmac4356-sdio.txt || true
          
          wget -O build/userpatches/overlay/lib/firmware/brcm/brcmfmac4356-sdio.bin \
            https://github.com/armbian/firmware/raw/master/brcm/brcmfmac4356-sdio.bin || true
          
          echo "无线固件下载完成"

      - name: Configure APT with retry and timeout
        working-directory: /builder
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "配置APT重试和超时设置..."
          mkdir -p build/userpatches/overlay/etc/apt/apt.conf.d
          
          # 创建APT配置文件，这会在chroot环境的apt-get update时生效
          cat > build/userpatches/overlay/etc/apt/apt.conf.d/99armbian-retry << 'EOF'
          // Armbian APT retry configuration
          // Increase retry count and timeout to handle mirror sync issues
          Acquire::Retries "5";
          Acquire::http::Timeout "120";
          Acquire::https::Timeout "120";
          Acquire::ftp::Timeout "120";
          EOF
          
          cat build/userpatches/overlay/etc/apt/apt.conf.d/99armbian-retry
          # 每次apt-get update会在包下载失败时重试

      - name: Clean cache and enforce mirror configuration
        working-directory: /builder
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "清理构建缓存，防止使用损坏的apt缓存..."
          
          # 删除可能损坏的apt缓存
          if [ -d "build/output/cache/apt" ]; then
            echo "删除旧的apt缓存目录..."
            sudo rm -rf build/output/cache/apt
            echo "apt缓存已清理"
          else
            echo "apt缓存目录不存在，跳过清理"
          fi
          
          # 验证镜像配置
          echo "================================"
          echo "验证Armbian镜像配置："
          if [ -f "build/userpatches/config-default.conf" ]; then
            echo "找到config-default.conf文件："
            cat build/userpatches/config-default.conf
          else
            echo "警告：config-default.conf文件不存在！"
          fi
          echo "================================"

      - name: Compile Armbian with linux-rockchip kernel [ bookworm ]
        id: compile
        working-directory: /builder
        if: ${{ steps.down.outputs.status }} == 'success' && !cancelled()
        run: |
          cd build/
          
          # 显式设置ARMBIAN_MIRROR环境变量，确保使用清华镜像源
          export ARMBIAN_MIRROR="${ARMBIAN_MIRROR}"
          
          echo "================================"
          echo "开始编译Armbian (使用清华镜像源和linux-rockchip内核)..."
          echo "使用镜像源: ${ARMBIAN_MIRROR}"
          echo "内核源: linux-rockchip"
          echo "================================"
          
          # 使用orangepi4-lts作为基础板（RK3399平台）
          # 使用 linux-rockchip 作为内核源
          ./compile.sh \
            ARMBIAN_MIRROR="${ARMBIAN_MIRROR}" \
            RELEASE=bookworm \
            BOARD=orangepi4-lts \
            BRANCH=current \
            KERNEL_SOURCE=linux-rockchip \
            BUILD_MINIMAL=no \
            BUILD_ONLY=default \
            HOST=armbian \
            BUILD_DESKTOP=no \
            EXPERT=yes \
            KERNEL_CONFIGURE=no \
            COMPRESS_OUTPUTIMAGE="sha,xz" \
            SHARE_LOG=yes
          
          # 检查编译结果
          echo "================================"
          echo "检查编译输出..."
          if [ -d "output/images" ]; then
            echo "Images目录内容:"
            ls -lah output/images/
          else
            echo "警告: output/images 目录不存在"
          fi
          echo "================================"
          
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Customize Armbian image with RK3399-YZD DTB
        working-directory: /builder
        if: ${{ steps.compile.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "集成RK3399-YZD DTB到Armbian镜像..."
          
          # 查找生成的镜像（优先查找压缩文件，支持 Armbian-unofficial 命名）
          IMAGE_FILE=$(find build/output/images -name "Armbian*.img.xz" -type f | head -n 1)
          
          if [ -z "$IMAGE_FILE" ]; then
            # 如果没有找到压缩文件，查找未压缩的
            IMAGE_FILE=$(find build/output/images -name "Armbian*.img" -type f | head -n 1)
          fi
          
          if [ -n "$IMAGE_FILE" ]; then
            echo "找到镜像文件: $IMAGE_FILE"
            ls -lh "$IMAGE_FILE"
            
            # 解压镜像（如果是压缩的）
            if [[ "$IMAGE_FILE" == *.xz ]]; then
              echo "解压镜像..."
              # 使用 sudo 解压以避免权限问题，并忽略文件属性警告
              sudo xz -d "$IMAGE_FILE" 2>/dev/null || sudo xz -d --no-warn "$IMAGE_FILE" || {
                echo "解压失败，尝试使用管道方式..."
                sudo xz -dc "$IMAGE_FILE" > "${IMAGE_FILE%.xz}"
                sudo rm -f "$IMAGE_FILE"
              }
              IMAGE_FILE="${IMAGE_FILE%.xz}"
              echo "解压后: $IMAGE_FILE"
              ls -lh "$IMAGE_FILE" 2>/dev/null || echo "文件可能需要 sudo 访问"
            fi
            
            # 挂载镜像
            echo "挂载镜像..."
            LOOP_DEV=$(sudo losetup -f)
            sudo losetup -P $LOOP_DEV "$IMAGE_FILE"
            
            # 挂载boot分区
            MOUNT_DIR=$(mktemp -d)
            sudo mount ${LOOP_DEV}p1 $MOUNT_DIR
            
            # 检查并创建DTB目录结构
            echo "检查DTB目录结构..."
            if [ -d "$MOUNT_DIR/dtb/rockchip" ]; then
              echo "DTB目录已存在: $MOUNT_DIR/dtb/rockchip"
            else
              echo "创建DTB目录结构..."
              sudo mkdir -p $MOUNT_DIR/dtb/rockchip
            fi
            
            # 复制定制的DTB
            echo "复制RK3399-YZD DTB..."
            sudo cp /builder/rk3399-yzd-linux.dtb $MOUNT_DIR/dtb/rockchip/rk3399-yzd.dtb
            echo "DTB文件已复制"
            ls -lh $MOUNT_DIR/dtb/rockchip/ | grep yzd || echo "验证DTB文件..."
            
            # 卸载
            sudo umount $MOUNT_DIR
            sudo losetup -d $LOOP_DEV
            
            # 重新压缩
            echo "重新压缩镜像..."
            sudo xz -z -9 -v "$IMAGE_FILE"
            
            echo "DTB集成完成"
          else
            echo "未找到镜像文件"
            echo "查看输出目录内容："
            ls -la build/output/images/ || echo "目录不存在"
          fi

      - name: Upload Armbian image
        uses: actions/upload-artifact@v4
        if: ${{ steps.compile.outputs.status }} == 'success' && !cancelled()
        with:
          name: Armbian-RK3399-YZD-apt-retry-test
          path: |
            /builder/build/output/images/Armbian*.img.xz
            /builder/build/output/images/Armbian*.img
          retention-days: 7
          if-no-files-found: warn

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: /builder/build/output/logs/
          retention-days: 7

      - name: Create Release and Upload Firmware
        if: ${{ steps.compile.outputs.status }} == 'success' && !cancelled()
        working-directory: /builder
        run: |
          echo "准备发布固件到 GitHub Releases..."
          
          # 查找生成的镜像文件
          IMAGE_FILES=$(find build/output/images -name "Armbian*.img.xz" -type f)
          
          if [ -z "$IMAGE_FILES" ]; then
            echo "未找到镜像文件，跳过发布"
            exit 0
          fi
          
          # 生成版本标签（使用日期和提交哈希）
          RELEASE_TAG="v$(date +%Y.%m.%d)-${GITHUB_SHA:0:7}"
          RELEASE_NAME="Armbian RK3399-YZD $(date +%Y-%m-%d)"
          
          echo "发布标签: $RELEASE_TAG"
          echo "发布名称: $RELEASE_NAME"
          
          # 创建发布说明
          cat > release_notes.md << EOF
          # Armbian RK3399-YZD 固件发布
          
          ## 构建信息
          - **构建时间**: $(date '+%Y-%m-%d %H:%M:%S %Z')
          - **分支**: ${GITHUB_REF#refs/heads/}
          - **提交**: ${GITHUB_SHA}
          - **内核源**: linux-rockchip
          - **发行版**: Debian Bookworm
          - **镜像源**: 清华大学 TUNA 镜像
          
          ## 功能特性
          - ✅ 使用 linux-rockchip 内核
          - ✅ 集成 RK3399-YZD 自定义 DTB
          - ✅ 优化的 apt-get 更新重试逻辑
          - ✅ 使用清华镜像源加速下载
          
          ## 安装说明
          1. 下载下方的 \`.img.xz\` 文件
          2. 解压缩: \`xz -d Armbian-*.img.xz\`
          3. 烧录到 SD 卡或 eMMC
          4. 首次启动后按提示配置系统
          
          ## 文件列表
          EOF
          
          # 添加文件列表到发布说明
          for img in $IMAGE_FILES; do
            filename=$(basename "$img")
            filesize=$(du -h "$img" | cut -f1)
            echo "- **$filename** ($filesize)" >> release_notes.md
          done
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "由 GitHub Actions 自动构建 | [构建日志](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})" >> release_notes.md
          
          cat release_notes.md
          
          # 使用 gh CLI 创建发布
          echo "${{ github.token }}" | gh auth login --with-token
          
          # 检查标签是否已存在，如果存在则删除
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "删除现有发布: $RELEASE_TAG"
            gh release delete "$RELEASE_TAG" -y --cleanup-tag
          fi
          
          # 创建新发布
          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_NAME" \
            --notes-file release_notes.md \
            --repo "${GITHUB_REPOSITORY}"
          
          # 上传镜像文件
          for img in $IMAGE_FILES; do
            echo "上传文件: $(basename $img)"
            gh release upload "$RELEASE_TAG" "$img" --repo "${GITHUB_REPOSITORY}"
            
            # 如果有 SHA 文件，也上传
            if [ -f "${img}.sha" ]; then
              gh release upload "$RELEASE_TAG" "${img}.sha" --repo "${GITHUB_REPOSITORY}"
            fi
          done
          
          echo "✅ 固件已成功发布到 GitHub Releases"
          echo "发布地址: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/releases/tag/${RELEASE_TAG}"

      - name: Build Summary
        if: always()
        run: |
          echo "========================================="
          echo "构建总结 - 使用清华镜像源和linux-rockchip内核"
          echo "========================================="
          echo ""
          echo "此工作流测试了以下改进:"
          echo "✓ 主机级 apt-get update 重试逻辑 (5次尝试)"
          echo "✓ 清华镜像源配置"
          echo "✓ linux-rockchip 内核源"
          echo "✓ APT缓存清理"
          echo "✓ RK3399-YZD DTS/DTB适配"
          echo ""
          if [ "${{ steps.compile.outputs.status }}" == "success" ]; then
            echo "✅ Armbian编译成功！apt-retry修复生效。"
          else
            echo "❌ Armbian编译失败，请检查日志。"
          fi
          echo "========================================="
