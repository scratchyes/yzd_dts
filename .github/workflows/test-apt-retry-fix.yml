#==========================================================================
# Description: Test workflow for apt-retry fix branch
# This workflow validates the apt-get retry logic improvements
#==========================================================================

name: Test Apt-Retry Fix

on:
  push:
    branches:
      - copilot/fix-ci-task-apt-update-error
  pull_request:
    branches:
      - main
      - master

env:
  TZ: Asia/Shanghai

jobs:
  test-build:
    runs-on: ubuntu-22.04
    name: Test Armbian Build with Apt-Retry Fix
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi $(docker images -q) 2>/dev/null || true
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          
          # Test the robust apt-get update with retry logic
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
              echo "尝试第 ${attempt}/${max_attempts} 次 apt-get update..."
              sudo apt-get clean
              sudo rm -rf /var/lib/apt/lists/*
              if sudo -E apt-get -y update; then
                  echo "apt-get update 成功!"
                  break
              fi
              if [ $attempt -eq $max_attempts ]; then
                  echo "错误: apt-get update 在 ${max_attempts} 次尝试后仍然失败"
                  exit 1
              fi
              echo "apt-get update 失败，等待 10 秒后重试..."
              sleep 10
              attempt=$((attempt+1))
          done
          
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          sudo -E apt-get -y install device-tree-compiler qemu-user-static binfmt-support
          sudo -E systemctl daemon-reload
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo timedatectl set-timezone "${TZ}"
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Validate Extension Script
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "验证 apt-retry 扩展脚本..."
          
          # Check if extension file exists
          if [ ! -f "userpatches/extension-apt-retry.sh" ]; then
              echo "错误: extension-apt-retry.sh 不存在!"
              exit 1
          fi
          
          # Check if extension is executable
          if [ ! -x "userpatches/extension-apt-retry.sh" ]; then
              echo "警告: extension-apt-retry.sh 不可执行，正在添加执行权限..."
              chmod +x userpatches/extension-apt-retry.sh
          fi
          
          # Validate bash syntax
          if ! bash -n userpatches/extension-apt-retry.sh; then
              echo "错误: extension-apt-retry.sh 语法错误!"
              exit 1
          fi
          
          echo "✓ 扩展脚本验证通过"
          
          # Check for required functions
          echo "检查必需的函数..."
          if ! grep -q "function extension_prepare_config__apt_retry" userpatches/extension-apt-retry.sh; then
              echo "错误: 缺少 extension_prepare_config__apt_retry 函数!"
              exit 1
          fi
          
          if ! grep -q "function robust_chroot_apt_update" userpatches/extension-apt-retry.sh; then
              echo "错误: 缺少 robust_chroot_apt_update 函数!"
              exit 1
          fi
          
          if ! grep -q "function pre_install_distribution_specific__robust_apt_update" userpatches/extension-apt-retry.sh; then
              echo "错误: 缺少 pre_install_distribution_specific__robust_apt_update 函数!"
              exit 1
          fi
          
          if ! grep -q "function post_repo_apt_update__robust_retry" userpatches/extension-apt-retry.sh; then
              echo "错误: 缺少 post_repo_apt_update__robust_retry 函数!"
              exit 1
          fi
          
          echo "✓ 所有必需的函数都存在"

      - name: Validate Mirror Configuration
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "验证镜像配置..."
          
          if [ ! -f "userpatches/config-default.conf" ]; then
              echo "错误: config-default.conf 不存在!"
              exit 1
          fi
          
          if ! grep -q "ARMBIAN_MIRROR" userpatches/config-default.conf; then
              echo "错误: config-default.conf 中缺少 ARMBIAN_MIRROR 配置!"
              exit 1
          fi
          
          echo "当前镜像配置:"
          cat userpatches/config-default.conf
          
          echo "✓ 镜像配置验证通过"

      - name: Check Workflow Integration
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          echo "检查工作流集成..."
          
          # Check if ENABLE_EXTENSIONS is present in workflow
          if ! grep -q "ENABLE_EXTENSIONS" .github/workflows/build-armbian.yml; then
              echo "警告: build-armbian.yml 中可能缺少 ENABLE_EXTENSIONS 配置"
          else
              echo "✓ 在 build-armbian.yml 中找到 ENABLE_EXTENSIONS 配置"
          fi
          
          # Check if extension is copied in workflow
          if ! grep -q "extension-apt-retry.sh" .github/workflows/build-armbian.yml; then
              echo "警告: build-armbian.yml 中可能缺少扩展脚本复制步骤"
          else
              echo "✓ 在 build-armbian.yml 中找到扩展脚本复制步骤"
          fi
          
          # Check retry logic in workflow
          if ! grep -q "max_attempts=5" .github/workflows/build-armbian.yml; then
              echo "警告: build-armbian.yml 中可能缺少主机级重试逻辑"
          else
              echo "✓ 在 build-armbian.yml 中找到主机级重试逻辑"
          fi

      - name: Summary
        if: always()
        run: |
          echo "========================================="
          echo "测试总结"
          echo "========================================="
          echo ""
          echo "此工作流验证了以下内容:"
          echo "✓ 主机级 apt-get update 重试逻辑"
          echo "✓ Armbian 扩展脚本存在且语法正确"
          echo "✓ 所有必需的钩子函数都已定义"
          echo "✓ 镜像配置文件存在"
          echo "✓ 工作流集成检查"
          echo ""
          echo "如需完整构建测试，请手动触发 build-armbian.yml 工作流"
          echo "========================================="
